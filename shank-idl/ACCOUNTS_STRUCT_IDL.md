# ShankAccounts IDL Generation

This document explains the current state of IDL generation for the new `ShankAccounts` macro and outlines the expected future improvements.

## Current Behavior

As of the initial implementation, the `ShankAccounts` macro generates placeholder entries in the IDL instead of expanding the individual accounts from the struct. This is due to the TODO item in `shank-idl/src/idl_instruction.rs` at line 58.

### Current IDL Output

When using `#[accounts(StructName)]` with a `ShankAccounts` struct:

```rust
#[derive(ShankAccounts)]
pub struct CreateVaultAccounts<'info> {
    #[account(mut, signer, desc = "The payer and authority")]
    pub payer: AccountInfo<'info>,
    
    #[account(mut, desc = "The vault account to create")]
    pub vault: AccountInfo<'info>,
    
    #[account(desc = "System program")]
    pub system_program: AccountInfo<'info>,
}

#[derive(ShankInstruction)]
pub enum VaultInstruction {
    #[accounts(CreateVaultAccounts)]
    CreateVault { seed: String },
}
```

Currently generates:

```json
{
  "instructions": [
    {
      "name": "CreateVault",
      "accounts": [
        {
          "name": "__accounts_struct_CreateVaultAccounts",
          "isMut": false,
          "isSigner": false,
          "docs": ["Accounts defined by struct: CreateVaultAccounts"]
        }
      ]
    }
  ]
}
```

## Expected Future Behavior

The IDL generation should be enhanced to resolve `AccountsSource::Struct` and expand the individual accounts from the `ShankAccounts` struct.

### Expected IDL Output

The same code should generate:

```json
{
  "instructions": [
    {
      "name": "CreateVault",
      "accounts": [
        {
          "name": "payer",
          "isMut": true,
          "isSigner": true,
          "docs": ["The payer and authority"]
        },
        {
          "name": "vault",
          "isMut": true,
          "isSigner": false,
          "docs": ["The vault account to create"]
        },
        {
          "name": "system_program",
          "isMut": false,
          "isSigner": false,
          "docs": ["System program"]
        }
      ]
    }
  ]
}
```

## Implementation Requirements

To achieve the expected behavior, the following changes are needed:

1. **Resolve AccountsSource::Struct**: The IDL generation logic in `shank-idl/src/idl_instruction.rs` needs to handle `AccountsSource::Struct` by looking up the referenced struct and extracting its account metadata.

2. **Access ShankAccounts Metadata**: The IDL generator needs to call the `__shank_accounts()` method generated by the `ShankAccounts` macro to get the account metadata.

3. **Convert Account Metadata**: Transform the account metadata from the `ShankAccounts` format into the IDL `InstructionAccount` format.

## Current Test Coverage

The following tests verify the current placeholder behavior:

- `instruction_from_single_file_with_simple_accounts_struct`
- `instruction_from_single_file_with_accounts_struct`
- `instruction_from_single_file_with_complex_accounts_struct`

These tests should be updated when the IDL generation is enhanced to match the expected behavior.

## Benefits of Full Implementation

Once fully implemented, the `ShankAccounts` system will provide:

1. **Single Source of Truth**: Account definitions in one place used for both runtime and IDL generation
2. **Type Safety**: Compile-time verification of account usage
3. **Anchor-like DX**: Familiar developer experience for Anchor users
4. **Backward Compatibility**: Existing shank programs continue to work unchanged
5. **Complete IDL**: Full account information in generated IDLs for tooling consumption

## Macro Integration

The `ShankAccounts` macro generates the `__shank_accounts()` method that returns account metadata in this format:

```rust
Vec<(u32, &'static str, bool, bool, bool, bool, Option<String>)>
// (index, name, writable, signer, optional_signer, optional, description)
```

This metadata should be consumed by the IDL generator to produce the expanded account list.